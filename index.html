<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>竞技版俄罗斯方块</title>
<style>
html,body{margin:0;padding:0;height:100%;width:100%;font-family:Arial,sans-serif;background:#111;color:#fff;}
body{display:flex;flex-direction:column;height:100vh;}
#gameContainer{flex:1;display:flex;flex-direction:row;overflow:hidden;width:100%;}
#leftControlsWrapper{width:30%;display:flex;flex-direction:column;box-sizing:border-box;padding:5px;}
#leaderboardWrapper{flex:1;overflow-y:auto;margin-bottom:5px;background:#222;padding:5px;border-radius:5px;}
#leaderboardWrapper ol{padding-left:15px;margin:5px 0;font-size:14px;}
#nextCanvasWrapper{height:120px;margin-bottom:5px;display:flex;justify-content:center;align-items:center;}
#nextCanvas{background:#000;border:2px solid #ffb347;border-radius:5px;}
#leftControls{display:flex;flex-direction:column;gap:5px;justify-content:flex-start;}
#leftControls select,#leftControls button{padding:6px 8px;font-size:14px;cursor:pointer;background:#ffb347;color:#000;border:none;border-radius:5px;box-shadow:1px 1px 3px rgba(0,0,0,0.4);}
#canvasWrapper{flex:1;display:flex;justify-content:center;align-items:center;position:relative;height:100%;width:70%;}
#gameCanvas{background:#000;border:3px solid #ffb347;border-radius:10px;touch-action:none;display:block;}
#touchControls{display:flex;justify-content:space-around;padding:5px;background:#222;}
#touchControls button{flex:1;margin:2px;font-size:18px;height:50px;border-radius:8px;border:none;background:#ffb347;color:#000;box-shadow:1px 1px 3px rgba(0,0,0,0.4);cursor:pointer;}
</style>
</head>
<body>

<div id="gameContainer">
  <div id="leftControlsWrapper">
    <div id="leaderboardWrapper">
      <strong>排行榜</strong>
      <ol id="leaderboard"></ol>
    </div>
    <div id="nextCanvasWrapper">
      <canvas id="nextCanvas" width="80" height="80"></canvas>
    </div>
    <div id="leftControls">
      <select id="difficulty">
        <option value="600">简单</option>
        <option value="350" selected>普通</option>
        <option value="180">困难</option>
      </select>
      <button id="startBtn">开始</button>
      <button id="pauseBtn">暂停</button>
    </div>
  </div>
  <div id="canvasWrapper">
    <canvas id="gameCanvas"></canvas>
  </div>
</div>

<div id="touchControls">
  <button id="leftBtn">⬅️</button>
  <button id="downBtn">⬇️</button>
  <button id="rotateBtn">↻</button>
  <button id="rightBtn">➡️</button>
  <button id="dropBtn">⏬</button>
</div>

<script>
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d');
const nextCanvas=document.getElementById('nextCanvas'),nextCtx=nextCanvas.getContext('2d');

const COLS=10,ROWS=20;
let BLOCK;
let board=[],current=null,nextPiece=null,dropInterval=null,speed=parseInt(document.getElementById('difficulty').value),paused=false,score=0;

const shapes=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]]];
const colors=['#ff0000','#ff7700','#ffff00','#77ff00','#00ff77','#00ffff','#7700ff'];

// Canvas 自适应右侧
function resizeCanvas(){
  const wrapper=document.getElementById('canvasWrapper');
  const w=Math.floor(wrapper.clientWidth*0.98);
  const h=Math.floor(wrapper.clientHeight*0.98);
  BLOCK=Math.floor(Math.min(w/COLS,h/ROWS));
  canvas.width=COLS*BLOCK;
  canvas.height=ROWS*BLOCK;
  draw();
}
window.addEventListener('resize',resizeCanvas);

function randomPiece(){return {shape:shapes[Math.floor(Math.random()*shapes.length)],color:colors[Math.floor(Math.random()*colors.length)],x:Math.floor(COLS/2)-1,y:0};}
function initBoard(){board=Array.from({length:ROWS},()=>Array(COLS).fill(0));}
function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);board.forEach((r,y)=>r.forEach((c,x)=>c&&drawBlock(x,y,c)));if(current) current.shape.forEach((r,i)=>r.forEach((c,j)=>c&&drawBlock(current.x+j,current.y+i,current.color)));drawNext();}
function drawBlock(x,y,c,ctxToUse=ctx,BLOCK_SIZE=BLOCK){ctxToUse.fillStyle=c;ctxToUse.fillRect(x*BLOCK_SIZE,y*BLOCK_SIZE,BLOCK_SIZE,BLOCK_SIZE);ctxToUse.strokeStyle="#000";ctxToUse.strokeRect(x*BLOCK_SIZE,y*BLOCK_SIZE,BLOCK_SIZE,BLOCK_SIZE);}
function drawNext(){if(!nextPiece) return;nextCtx.clearRect(0,0,nextCanvas.width,nextCanvas.height);const size=Math.min(nextCanvas.width/4,nextCanvas.height/4);nextPiece.shape.forEach((r,i)=>r.forEach((c,j)=>{if(c) drawBlock(j,i,nextPiece.color,nextCtx,size);}));}
function collide(dx=0,dy=0,shape=null){shape=shape||current.shape;return shape.some((r,i)=>r.some((c,j)=>c&&(current.x+j+dx<0||current.x+j+dx>=COLS||current.y+i+dy>=ROWS||(current.y+i+dy>=0&&board[current.y+i+dy][current.x+j]))));}
function rotatePiece(){const r=current.shape[0].map((_,i)=>current.shape.map(row=>row[i]).reverse());if(!collide(0,0,r)) current.shape=r;}
function movePiece(dx){if(!collide(dx,0)) current.x+=dx;}
function hardDrop(){while(!collide(0,1)) current.y++;drop();}

function drop(){
  if(paused||!current) return;
  if(!collide(0,1)){current.y++;draw();}
  else{merge();clearLines();current=nextPiece;nextPiece=randomPiece();if(collide()) gameOver();draw();}
}

function merge(){current.shape.forEach((r,i)=>r.forEach((c,j)=>{if(c&&current.y+i>=0) board[current.y+i][current.x+j]=current.color;}));}
function clearLines(){for(let y=ROWS-1;y>=0;y--){if(board[y].every(v=>v)){board.splice(y,1);board.unshift(Array(COLS).fill(0));y++;score+=10;}}}
function gameOver(){clearInterval(dropInterval);alert("游戏结束! 分数:"+score);saveScore(score);updateLeaderboard();}

function saveScore(s){let arr=JSON.parse(localStorage.getItem('tetrisScores')||'[]');arr.push(s);arr.sort((a,b)=>b-a);if(arr.length>5) arr.length=5;localStorage.setItem('tetrisScores',JSON.stringify(arr));}
function updateLeaderboard(){const list=document.getElementById('leaderboard');list.innerHTML='';JSON.parse(localStorage.getItem('tetrisScores')||'[]').forEach(s=>{let li=document.createElement('li');li.innerText=s;list.appendChild(li);});}

function startGame(){
  initBoard();
  current=randomPiece();
  nextPiece=randomPiece();
  score=0;
  paused=false;
  if(dropInterval) clearInterval(dropInterval);
  dropInterval=setInterval(drop,speed);
  draw();
  updateLeaderboard();
}

document.getElementById('startBtn').onclick=startGame;
document.getElementById('pauseBtn').onclick=()=>{paused=!paused;};
document.getElementById('difficulty').onchange=e=>{speed=parseInt(e.target.value);if(dropInterval){clearInterval(dropInterval);dropInterval=setInterval(drop,speed);}};

// 竞技级 DAS + 多键独立响应
const keyState={}, keyTimers={}, DAS_INTERVAL=50;
document.addEventListener('keydown',e=>{
  if(!current) return;
  if(!keyState[e.key]){keyState[e.key]=true; keyAction(e.key); keyTimers[e.key]=setInterval(()=>keyAction(e.key),DAS_INTERVAL);}
});
document.addEventListener('keyup',e=>{
  keyState[e.key]=false;
  if(keyTimers[e.key]){clearInterval(keyTimers[e.key]); delete keyTimers[e.key];}
});
function keyAction(key){
  if(!current) return;
  switch(key){
    case 'ArrowLeft': movePiece(-1); break;
    case 'ArrowRight': movePiece(1); break;
    case 'ArrowDown': drop(); break;
    case 'ArrowUp': rotatePiece(); break;
    case ' ': hardDrop(); break;
  }
}

// 触屏按钮
['leftBtn','rightBtn','downBtn'].forEach(id=>{
  const btn=document.getElementById(id);
  btn.onmousedown=btn.ontouchstart=()=>{keyState[btn.id]=true; keyActionMap(btn.id); keyTimers[btn.id]=setInterval(()=>keyActionMap(btn.id),DAS_INTERVAL);}
  btn.onmouseup=btn.ontouchend=()=>{keyState[btn.id]=false; if(keyTimers[btn.id]){clearInterval(keyTimers[btn.id]); delete keyTimers[btn.id];}}
});
document.getElementById('rotateBtn').onclick=document.getElementById('dropBtn').onclick=function(){if(this.id==='rotateBtn') rotatePiece(); else hardDrop();}
function keyActionMap(id){switch(id){case 'leftBtn':movePiece(-1);break;case 'rightBtn':movePiece(1);break;case 'downBtn':drop();break;}}

// 手势滑动
let touchStartX=0,touchStartY=0;
canvas.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY;});
canvas.addEventListener('touchend',e=>{
  let dx=e.changedTouches[0].clientX-touchStartX;
  let dy=e.changedTouches[0].clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)){if(dx>30) movePiece(1);else if(dx<-30) movePiece(-1);}
  else{if(dy<-30) rotatePiece();else if(dy>30) drop();}
});

resizeCanvas();
updateLeaderboard();
</script>
</body>
</html>
