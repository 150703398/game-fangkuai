<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>卡通风格网页俄罗斯方块</title>
<style>
body {
  margin:0; padding:0;
  font-family: Arial, sans-serif;
  background:#a0eaff;
  color:#000;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#scoreBoard {
  padding:5px 10px;
  font-size:16px;
  text-align:center;
}
#scoreBoard ol {padding-left:20px; margin:5px 0;}
#gameArea {
  display:flex;
  flex:1;
  padding:5px;
  gap:10px;
  box-sizing:border-box;
}
#leftControls, #rightControls {
  display:flex;
  flex-direction:column;
  gap:8px;
  justify-content:flex-start;
}
#leftControls button, #leftControls select {
  padding:6px 12px;
  font-size:14px;
  cursor:pointer;
  background:#ffb347; color:#000; border:none; border-radius:6px;
  box-shadow:2px 2px 4px rgba(0,0,0,0.5);
}
#rightControls button {
  padding:10px 16px;
  font-size:16px;
  cursor:pointer;
  background:#ffb347; color:#000; border:none; border-radius:8px;
  box-shadow:2px 2px 5px rgba(0,0,0,0.5);
}
#gameCanvas {
  background:#fff;
  border:3px solid #ffb347;
  border-radius:10px;
  flex-grow:1;
  touch-action:none;
}
#touchControls {
  display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
  padding:5px 0; background:rgba(255,255,255,0.2);
}
#touchControls button {
  width:60px; height:60px; font-size:20px;
  border-radius:8px; border:none; background:#ffb347; color:#000;
  box-shadow:1px 1px 3px rgba(0,0,0,0.5); cursor:pointer;
}
</style>
</head>
<body>

<div id="scoreBoard">
  分数: <span id="score">0</span> &nbsp;&nbsp;
  <strong>本地排行榜</strong>
  <ol id="leaderboard"></ol>
</div>

<div id="gameArea">
  <div id="leftControls">
    <select id="difficulty">
      <option value="600">简单</option>
      <option value="350" selected>普通</option>
      <option value="180">困难</option>
    </select>
    <button id="toggleSoundBtn">BGM/音效开关</button>
    <button id="startBtn">开始</button>
    <button id="pauseBtn">暂停</button>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="rightControls">
    <!-- 右侧空着也行，排行榜已在顶部显示 -->
  </div>
</div>

<div id="touchControls">
  <button id="leftBtn">⬅️</button>
  <button id="rotateBtn">↻</button>
  <button id="rightBtn">➡️</button>
  <button id="downBtn">⬇️</button>
</div>

<audio id="bgm" loop src="https://freepd.com/music/Donuts_Ondependent_Loop.mp3"></audio>
<audio id="moveSfx" src="https://freepd.com/sound/effects/tetris_move.wav"></audio>
<audio id="lineSfx" src="https://freepd.com/sound/effects/tetris_clear.wav"></audio>

<script>
// —— Canvas自适应
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
let COLS=10, ROWS=20;
let BLOCK;
function resizeCanvas(){
  const areaHeight = document.getElementById('gameArea').clientHeight;
  const areaWidth = document.getElementById('gameArea').clientWidth - 160; // 左侧控件宽度
  BLOCK=Math.floor(Math.min(areaWidth/COLS, areaHeight/ROWS));
  canvas.width=COLS*BLOCK;
  canvas.height=ROWS*BLOCK;
  draw();
}
window.addEventListener('resize',resizeCanvas);

// —— 音效
let soundOn=false;
const bgm=document.getElementById('bgm');
const moveSfx=document.getElementById('moveSfx');
const lineSfx=document.getElementById('lineSfx');
function playSound(audio){if(soundOn) audio.play();}

// —— 游戏逻辑
const shapes=[
[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],
[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]]
];
let colors=['#ff0000','#ff7700','#ffff00','#77ff00','#00ff77','#00ffff','#7700ff'];
let board,current,nextPiece,score,dropInterval,paused=false,speed=parseInt(document.getElementById('difficulty').value);

// —— 初始化游戏
function initGame(){
  board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  score=0; document.getElementById('score').innerText=score;
  current=randomPiece();
  nextPiece=randomPiece();
  clearInterval(dropInterval);
  dropInterval=setInterval(gameLoop,speed);
  paused=false;
  if(soundOn) bgm.play();
  resizeCanvas();
  updateLeaderboard();
}

function randomPiece(){return {shape:shapes[Math.floor(Math.random()*shapes.length)],color:colors[Math.floor(Math.random()*colors.length)],x:Math.floor(COLS/2)-1,y:0};}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  board.forEach((r,y)=>r.forEach((c,x)=>c&&drawBlock(x,y,c)));
  if(current) current.shape.forEach((r,i)=>r.forEach((c,j)=>c&&drawBlock(current.x+j,current.y+i,current.color)));
}

function drawBlock(x,y,c){
  ctx.fillStyle=c; ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);
  ctx.strokeStyle='#fff'; ctx.strokeRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);
}

function collide(dx=0,dy=0,shape=null){
  shape=shape||current.shape;
  return shape.some((r,i)=>r.some((c,j)=>c&&(current.x+j+dx<0||current.x+j+dx>=COLS||current.y+i+dy>=ROWS||(current.y+i+dy>=0&&board[current.y+i+dy][current.x+j]))));
}

function rotatePiece(){
  const r=current.shape[0].map((_,i)=>current.shape.map(row=>row[i]).reverse());
  if(!collide(0,0,r)){current.shape=r;playSound(moveSfx);}
}

function movePiece(dx){if(!collide(dx,0)){current.x+=dx;playSound(moveSfx);}}

function drop(){if(!paused){if(!collide(0,1)){current.y++;}else{merge();clearLines();current=nextPiece;nextPiece=randomPiece();if(collide()) gameOver();}draw();}}

function merge(){current.shape.forEach((r,i)=>r.forEach((c,j)=>{if(c&&current.y+i>=0) board[current.y+i][current.x+j]=current.color;}));}

function clearLines(){
  let cleared=0;
  for(let y=ROWS-1;y>=0;y--){
    if(board[y].every(v=>v)){board.splice(y,1);board.unshift(Array(COLS).fill(0));cleared++;playSound(lineSfx);y++;}
  }
  score+=cleared*10; document.getElementById('score').innerText=score;
}

function gameOver(){clearInterval(dropInterval);alert("游戏结束! 分数: "+score);saveScore(score);updateLeaderboard();}

function saveScore(s){
  let arr=JSON.parse(localStorage.getItem('tetrisScores')||'[]'); arr.push(s); arr.sort((a,b)=>b-a); if(arr.length>5) arr.length=5;
  localStorage.setItem('tetrisScores',JSON.stringify(arr));
}

function updateLeaderboard(){
  const list=document.getElementById('leaderboard'); list.innerHTML='';
  JSON.parse(localStorage.getItem('tetrisScores')||'[]').forEach(s=>{let li=document.createElement('li');li.innerText=s;list.appendChild(li);});
}

// —— 控件事件
document.getElementById('startBtn').onclick=()=>{paused=false; initGame();};
document.getElementById('pauseBtn').onclick=()=>{paused=!paused; if(paused) bgm.pause(); else if(soundOn) bgm.play();};
document.getElementById('toggleSoundBtn').onclick=()=>{soundOn=!soundOn; if(soundOn&&!paused){bgm.play();} else {bgm.pause();}};
document.getElementById('difficulty').onchange=(e)=>{speed=parseInt(e.target.value); if(dropInterval){clearInterval(dropInterval); dropInterval=setInterval(gameLoop,speed);}};

// —— 键盘控制
document.addEventListener('keydown',e=>{if(!current) return; if(e.key==='ArrowLeft') movePiece(-1); if(e.key==='ArrowRight') movePiece(1); if(e.key==='ArrowDown') drop(); if(e.key==='ArrowUp') rotatePiece();});

// —— 触屏按钮
document.getElementById('leftBtn').onclick=()=>movePiece(-1);
document.getElementById('rightBtn').onclick=()=>movePiece(1);
document.getElementById('downBtn').onclick=()=>drop();
document.getElementById('rotateBtn').onclick=()=>rotatePiece();

// —— 手势控制
let touchStartX=0,touchStartY=0;
canvas.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY;});
canvas.addEventListener('touchend',e=>{
  let dx=e.changedTouches[0].clientX-touchStartX;
  let dy=e.changedTouches[0].clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)){if(dx>30) movePiece(1); else if(dx<-30) movePiece(-1);}
  else{if(dy<-30) rotatePiece(); else if(dy>30) drop();}
});

// —— 游戏循环
function gameLoop(){drop();}

// 初始化
resizeCanvas();
</script>
</body>
</html>
