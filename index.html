<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>卡通俄罗斯方块</title>

<style>
*{box-sizing:border-box;font-family:"Comic Sans MS","Arial Rounded MT Bold",sans-serif}
body{
  margin:0;
  height:100vh;
  background:#cceeff;
  display:flex;
  flex-direction:column;
}

#main{
  flex:1;
  display:flex;
  width:100%;
}

#left{
  width:30%;
  background:#fff3cd;
  display:flex;
  flex-direction:column;
}

.panel{
  background:#fff;
  border-radius:10px;
  padding:6px;
  margin:6px;
  text-align:center;
}

#rankBox{flex:1}
#controlBox{flex:1;display:flex;flex-direction:column;gap:8px}

#nextCanvas{
  width:100%;
  aspect-ratio:1/1;
  background:#333;
  border-radius:8px;
}

#right{
  width:70%;
  padding:6px;
}

#gameCanvas{
  width:100%;
  height:100%;
  aspect-ratio:10/20;
  background:#222;
  border-radius:14px;
  touch-action:none;
}

#controls{
  height:90px;
  width:100vw;
  display:flex;
  background:#b3e0ff;
}

.ctrl{
  flex:1;
  margin:6px;
  border-radius:14px;
  background:#ffb84d;
  font-size:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.ctrl:active{background:#ff9f1a}

button,select{
  width:100%;
  padding:6px;
  font-size:13px;
  border:none;
  border-radius:8px;
  background:#4db8ff;
  color:#fff;
}
</style>
</head>

<body>

<div id="main">
  <div id="left">
    <div id="rankBox" class="panel">
      <h3>排行榜</h3>
      <div id="rankList">暂无记录</div>
    </div>

    <div id="controlBox" class="panel">
      <div>
        <b>下一个方块</b>
        <canvas id="nextCanvas" width="80" height="80"></canvas>
      </div>

      <select id="difficulty">
        <option value="800">简单</option>
        <option value="500">普通</option>
        <option value="300">困难</option>
      </select>

      <button onclick="startGame()">开始</button>
      <button onclick="pauseGame()">暂停</button>
    </div>
  </div>

  <div id="right">
    <canvas id="gameCanvas"></canvas>
  </div>
</div>

<div id="controls">
  <div class="ctrl" id="btnLeft">⬅</div>
  <div class="ctrl" id="btnDown">⬇</div>
  <div class="ctrl" id="btnRotate">⟳</div>
  <div class="ctrl" id="btnRight">➡</div>
</div>

<script>
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
const COLS=10,ROWS=20;
let size;

function resize(){
  const w=canvas.clientWidth;
  canvas.width=w;
  canvas.height=w*2;
  size=canvas.width/COLS;
}
window.addEventListener("resize",resize);
resize();

const shapes=[
 [[1,1,1,1]],
 [[1,1],[1,1]],
 [[0,1,0],[1,1,1]],
 [[1,0,0],[1,1,1]],
 [[0,0,1],[1,1,1]],
];

let board,cur,next,x,y,loop,paused=false;

function reset(){
  board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  next=null;
  newPiece();
}

function newPiece(){
  cur=next||rand();
  next=rand();
  x=3;y=0;
  drawNext();
}

function rand(){return shapes[Math.random()*shapes.length|0];}

function draw(){
  ctx.fillStyle="#222";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  board.forEach((r,yy)=>r.forEach((v,xx)=>{
    if(v) block(xx,yy,"#4db8ff");
  }));
  cur.forEach((r,yy)=>r.forEach((v,xx)=>{
    if(v) block(x+xx,y+yy,"#ff6666");
  }));
}

function block(xx,yy,c){
  ctx.fillStyle=c;
  ctx.fillRect(xx*size,yy*size,size-1,size-1);
}

function collide(nx,ny){
  return cur.some((r,yy)=>r.some((v,xx)=>{
    if(!v)return false;
    let px=nx+xx,py=ny+yy;
    return px<0||px>=COLS||py>=ROWS||board[py]?.[px];
  }));
}

function move(dx,dy){
  if(!paused && !collide(x+dx,y+dy)){x+=dx;y+=dy;draw();}
}

function rotate(){
  if(paused)return;
  const r=cur[0].map((_,i)=>cur.map(r=>r[i]).reverse());
  const o=cur;cur=r;
  if(collide(x,y))cur=o;
  draw();
}

function drop(){
  if(paused)return;
  if(!collide(x,y+1))y++;
  else{
    cur.forEach((r,yy)=>r.forEach((v,xx)=>{
      if(v)board[y+yy][x+xx]=1;
    }));
    clear();
    newPiece();
  }
  draw();
}

function clear(){
  board=board.filter(r=>r.some(v=>!v));
  while(board.length<ROWS)board.unshift(Array(COLS).fill(0));
}

function startGame(){
  clearInterval(loop);
  reset();
  paused=false;
  loop=setInterval(drop,difficulty.value);
}

function pauseGame(){paused=!paused;}

function drawNext(){
  const n=document.getElementById("nextCanvas");
  const c=n.getContext("2d");
  c.clearRect(0,0,n.width,n.height);
  next.forEach((r,y)=>r.forEach((v,x)=>{
    if(v){
      c.fillStyle="#4db8ff";
      c.fillRect(x*20,y*20,18,18);
    }
  }));
}

/* ===== 手势控制 ===== */
let sx,sy;
canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  sx=t.clientX; sy=t.clientY;
});
canvas.addEventListener("touchend",e=>{
  const dx=e.changedTouches[0].clientX-sx;
  const dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>30) move(1,0);
    else if(dx<-30) move(-1,0);
  }else{
    if(dy>30) move(0,1);
    else if(dy<-30) rotate();
  }
});

/* ===== 长按方向键 ===== */
function bindHold(btn,fn){
  let t;
  btn.onmousedown=btn.ontouchstart=()=>{
    fn();
    t=setInterval(fn,120);
  };
  btn.onmouseup=btn.onmouseleave=btn.ontouchend=()=>clearInterval(t);
}
bindHold(btnLeft,()=>move(-1,0));
bindHold(btnRight,()=>move(1,0));
bindHold(btnDown,()=>move(0,1));
btnRotate.onclick=rotate;
</script>

</body>
</html>
