<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>可商用 网页俄罗斯方块</title>
<style>
  body {
    margin: 0;
    padding: 0;
    background: #222;
    color: #fff;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #gameCanvas {
    background: #000;
    border: 2px solid #fff;
    margin: 10px 0;
  }
  #controls, #touchControls {
    margin: 10px;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }
  button, select {
    padding: 10px 16px;
    font-size: 16px;
    cursor: pointer;
  }
  #touchControls button {
    width: 60px;
    height: 60px;
    font-size: 20px;
  }
  #scoreBoard {
    text-align: center;
    margin-top: 10px;
  }
</style>
</head>
<body>

<h1>网页俄罗斯方块</h1>
<canvas id="gameCanvas"></canvas>

<div id="controls">
  <button id="startBtn">开始</button>
  <button id="pauseBtn">暂停</button>
  <button id="toggleSoundBtn">BGM/音效 开关</button>
  <select id="difficulty">
    <option value="600">简单</option>
    <option value="350" selected>普通</option>
    <option value="180">困难</option>
  </select>
</div>

<div id="touchControls">
  <button id="leftBtn">⬅️</button>
  <button id="rotateBtn">↻</button>
  <button id="rightBtn">➡️</button>
  <button id="downBtn">⬇️</button>
</div>

<div id="scoreBoard">
  分数: <span id="score">0</span><br>
  <strong>本地排行榜</strong>
  <ol id="leaderboard"></ol>
</div>

<!-- 公共领域/免费可商用音频 -->
<audio id="bgm" loop src="https://freepd.com/music/Donuts_Ondependent_Loop.mp3"></audio>
<audio id="moveSfx" src="https://freepd.com/sound/effects/tetris_move.wav"></audio>
<audio id="lineSfx" src="https://freepd.com/sound/effects/tetris_clear.wav"></audio>

<script>
// ——————— 基本设定 ———————
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const COLS = 10, ROWS = 20;
const BLOCK = 30;
canvas.width = COLS * BLOCK;
canvas.height = ROWS * BLOCK;

// 触屏自适配
function resizeCanvas() {
  const scale = Math.min(window.innerWidth / canvas.width, window.innerHeight / canvas.height) * 0.9;
  canvas.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ——————— 音效处理 ———————
let soundOn = false;
const bgm = document.getElementById('bgm');
const moveSfx = document.getElementById('moveSfx');
const lineSfx = document.getElementById('lineSfx');
function playSound(audio) { if(soundOn) audio.play(); }

// ——————— 游戏逻辑 ———————
const shapes = [
  [[1,1,1,1]],               // I
  [[1,1],[1,1]],             // O
  [[0,1,0],[1,1,1]],         // T
  [[1,0,0],[1,1,1]],         // L
  [[0,0,1],[1,1,1]],         // J
  [[1,1,0],[0,1,1]],         // S
  [[0,1,1],[1,1,0]]          // Z
];
const colors = ['cyan','yellow','purple','orange','blue','green','red'];
let board, current, nextPiece, score, dropInterval, paused;

function initGame() {
  board = Array.from({length: ROWS}, ()=>Array(COLS).fill(0));
  score = 0; document.getElementById('score').innerText = score;
  current = randomPiece();
  nextPiece = randomPiece();
  clearInterval(dropInterval);
  dropInterval = setInterval(drop, speed);
  paused = false;
  if(soundOn) bgm.play();
  updateLeaderboard();
}

function randomPiece() {
  const id = Math.floor(Math.random() * shapes.length);
  return { shape: shapes[id], color: colors[id], x: Math.floor(COLS/2)-1, y: 0 };
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  board.forEach((row,y)=>{
    row.forEach((col,x)=>{ if(col) drawBlock(x,y,col); });
  });
  current.shape.forEach((r,i)=>{
    r.forEach((c,j)=>{ if(c) drawBlock(current.x+j, current.y+i, current.color); });
  });
}

function drawBlock(x,y,col) {
  ctx.fillStyle = col; ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);
  ctx.strokeStyle = '#111'; ctx.strokeRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);
}

function collide(dx=0,dy=0,shape=null) {
  shape = shape||current.shape;
  return shape.some((r,i)=>r.some((c,j)=>{
    if(!c) return false;
    let newX = current.x+j+dx, newY = current.y+i+dy;
    return newX<0 || newX>=COLS || newY>=ROWS || (newY>=0 && board[newY][newX]);
  }));
}

function rotatePiece() {
  const rotated = current.shape[0].map((_,i)=>current.shape.map(r=>r[i]).reverse());
  if(!collide(0,0,rotated)) { current.shape = rotated; playSound(moveSfx); }
}

function movePiece(dx) {
  if(!collide(dx,0)) { current.x += dx; playSound(moveSfx); }
}

function drop() {
  if(!collide(0,1)) { current.y++; }
  else {
    merge();
    clearLines();
    current = nextPiece;
    nextPiece = randomPiece();
    if(collide()) gameOver();
  }
  draw();
}

function merge() {
  current.shape.forEach((r,i)=>r.forEach((c,j)=>{
    if(c && current.y+i>=0) board[current.y+i][current.x+j] = current.color;
  }));
}

function clearLines() {
  let cleared = 0;
  for(let y=ROWS-1;y>=0;y--) {
    if(board[y].every(v=>v)) {
      board.splice(y,1);
      board.unshift(Array(COLS).fill(0));
      cleared++; playSound(lineSfx);
      y++;
    }
  }
  score += cleared*10;
  document.getElementById('score').innerText = score;
}

function gameOver() {
  clearInterval(dropInterval);
  alert("游戏结束! 分数: "+score);
  saveScore(score); updateLeaderboard();
}

function saveScore(s) {
  let arr = JSON.parse(localStorage.getItem('tetrisScores')||'[]');
  arr.push(s); arr.sort((a,b)=>b-a);
  if(arr.length>5) arr.length=5;
  localStorage.setItem('tetrisScores',JSON.stringify(arr));
}

function updateLeaderboard() {
  const list = document.getElementById('leaderboard');
  list.innerHTML = '';
  JSON.parse(localStorage.getItem('tetrisScores')||'[]')
    .forEach(s=>{ let li=document.createElement('li'); li.innerText=s; list.appendChild(li); });
}

// ——————— 控件事件 ———————
let speed = parseInt(document.getElementById('difficulty').value);
document.getElementById('startBtn').onclick = initGame;
document.getElementById('pauseBtn').onclick = ()=>{
  paused = !paused; if(paused) bgm.pause(); else if(soundOn) bgm.play();
};
document.getElementById('toggleSoundBtn').onclick = ()=>{
  soundOn = !soundOn; if(soundOn && !paused) bgm.play(); else bgm.pause();
};
document.getElementById('difficulty').onchange = (e)=>{
  speed = parseInt(e.target.value);
  if(dropInterval) { clearInterval(dropInterval); dropInterval=setInterval(drop,speed); }
};

// 键盘控制
document.addEventListener('keydown',e=>{
  if(!current) return;
  if(e.key==='ArrowLeft') movePiece(-1);
  if(e.key==='ArrowRight') movePiece(1);
  if(e.key==='ArrowDown') drop();
  if(e.key==='ArrowUp') rotatePiece();
});

// 触屏按钮
document.getElementById('leftBtn').onclick = ()=>movePiece(-1);
document.getElementById('rightBtn').onclick = ()=>movePiece(1);
document.getElementById('downBtn').onclick = ()=>drop();
document.getElementById('rotateBtn').onclick = ()=>rotatePiece();

</script>
</body>
</html>
