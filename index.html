<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>职业级竞技版俄罗斯方块（卡通风格）</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:sans-serif;background:#222;color:#fff;display:flex;flex-direction:column;}
#main{flex:1;display:flex;overflow:hidden;}
#left{width:30%;padding:8px;display:flex;flex-direction:column;gap:8px;}
#right{width:70%;display:flex;justify-content:center;align-items:center;}
.panel{background:#333;border-radius:10px;padding:8px;}
h3{margin:4px 0;font-size:14px;text-align:center;}
#gameWrap{width:100%;max-width:420px;aspect-ratio:10/20;}
canvas{display:block;width:100%;height:auto;background:#000;border-radius:10px;}
#controls{display:flex;width:100%;margin-top:4px;}
.ctrl{flex:1;margin:2px;padding:14px;font-size:18px;border-radius:10px;background:#555;color:#fff;user-select:none;}
.ctrl:active{background:#888;}
button,select{width:100%;padding:6px;margin:3px 0;border-radius:8px;border:none;font-size:14px;}
</style>
</head>
<body>
<div id="main">
  <div id="left">
    <div class="panel"><h3>排行榜</h3><div id="rank">暂无</div></div>
    <div class="panel"><h3>下一个方块</h3><canvas id="next" width="80" height="80"></canvas></div>
    <div class="panel">
      <select id="level">
        <option value="800">简单</option>
        <option value="500" selected>普通</option>
        <option value="300">困难</option>
      </select>
      <button id="start">开始</button>
      <button id="pause">暂停</button>
    </div>
  </div>
  <div id="right">
    <div id="gameWrap">
      <canvas id="game" width="300" height="600"></canvas>
    </div>
  </div>
</div>
<div id="controls">
  <div class="ctrl" id="leftBtn">◀</div>
  <div class="ctrl" id="downBtn">▼</div>
  <div class="ctrl" id="rotBtn">⟳</div>
  <div class="ctrl" id="rightBtn">▶</div>
</div>

<script>
// ==================== 基础参数 ====================
const COLS=10,ROWS=20,BLOCK=30;
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
const nextC=document.getElementById("next"),nctx=nextC.getContext("2d");

let board=[],cur,next,bag=[],state="idle",score=0,combo=0;
let dropInterval=500,dropTimer=0,lockTimer=0,LOCK_DELAY=500,lastTime=0;

// ==================== 方块 ====================
const SHAPES={
 I:[[1,1,1,1]],
 O:[[1,1],[1,1]],
 T:[[0,1,0],[1,1,1]],
 S:[[0,1,1],[1,1,0]],
 Z:[[1,1,0],[0,1,1]],
 J:[[1,0,0],[1,1,1]],
 L:[[0,0,1],[1,1,1]]
};
const COLORS={I:"#4df",O:"#fd4",T:"#d5f",S:"#4f4",Z:"#f44",J:"#44f",L:"#fa4"};

// ==================== 7-Bag 随机 ====================
function newBag(){ bag=Object.keys(SHAPES).sort(()=>Math.random()-0.5);}
function getNext(){ if(!bag.length)newBag(); const k=bag.pop(); return {k,shape:SHAPES[k],x:3,y:0};}

// ==================== 初始化 ====================
function reset(){
 board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
 score=0;combo=0;
 cur=getNext(); next=getNext();
 dropTimer=0;lockTimer=0;
 state="playing";
}

// ==================== 碰撞 ====================
function canMove(x,y,shape){
 for(let r=0;r<shape.length;r++)
  for(let c=0;c<shape[r].length;c++)
   if(shape[r][c]){
    let nx=x+c,ny=y+r;
    if(nx<0||nx>=COLS||ny>=ROWS) return false;
    if(ny>=0 && board[ny][nx]) return false;
   }
 return true;
}

// ==================== 主循环 ====================
function loop(t){
 if(state!=="playing"){lastTime=t;requestAnimationFrame(loop);return;}
 let dt=t-lastTime;lastTime=t;
 dropTimer+=dt;

 // 下落
 if(dropTimer>=dropInterval){
   if(canMove(cur.x,cur.y+1,cur.shape)){
     cur.y++; lockTimer=0;
   }else{
     lockTimer+=dt;
     if(lockTimer>=LOCK_DELAY) lock();
   }
   dropTimer=0;
 }
 draw();
 requestAnimationFrame(loop);
}

// ==================== 锁定 ====================
function lock(){
 cur.shape.forEach((r,y)=>r.forEach((v,x)=>{
  if(v) board[cur.y+y][cur.x+x]=cur.k;
 }));
 clearLines();
 cur=next; next=getNext(); lockTimer=0;
 if(!canMove(cur.x,cur.y,cur.shape)) state="gameover";
}

// ==================== 消行 ====================
function clearLines(){
 let lines=0;
 board=board.filter(r=>{
  if(r.every(v=>v)){lines++;return false;}
  return true;
 });
 while(board.length<ROWS) board.unshift(Array(COLS).fill(0));
 if(lines){combo++;score+=lines*100*combo;}else combo=0;
}

// ==================== 绘制 ====================
function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 board.forEach((r,y)=>r.forEach((v,x)=>{if(v){ctx.fillStyle=COLORS[v];ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);}}));
 drawGhost();
 drawPiece(cur);
 drawNext();
}
function drawPiece(p){
 ctx.fillStyle=COLORS[p.k];
 p.shape.forEach((r,y)=>r.forEach((v,x)=>{if(v)ctx.fillRect((p.x+x)*BLOCK,(p.y+y)*BLOCK,BLOCK,BLOCK);}));
}
function drawGhost(){
 let y=cur.y;
 while(canMove(cur.x,y+1,cur.shape))y++;
 ctx.globalAlpha=0.3; drawPiece({...cur,y}); ctx.globalAlpha=1;
}
function drawNext(){
 nctx.clearRect(0,0,80,80);
 next.shape.forEach((r,y)=>r.forEach((v,x)=>{if(v){nctx.fillStyle=COLORS[next.k];nctx.fillRect(x*20,y*20,20,20);}}));
}

// ==================== 操作 ====================
function move(dx){if(canMove(cur.x+dx,cur.y,cur.shape)){cur.x+=dx;lockTimer=0;}}
function rotate(){const r=cur.shape[0].map((_,i)=>cur.shape.map(row=>row[i]).reverse());if(canMove(cur.x,cur.y,r)){cur.shape=r;lockTimer=0;}}
function softDrop(){if(canMove(cur.x,cur.y+1,cur.shape)){cur.y++;score++;}}

// ==================== 按钮 ====================
start.onclick=()=>{dropInterval=+level.value;reset();}
pause.onclick=()=>{state=state==="playing"?"paused":"playing";}

// ==================== 长按 & 滑动 ====================
let holdKey=null,holdTimer=null;
function startHold(k){holdKey=k;doHold();holdTimer=setInterval(doHold,60);}
function doHold(){if(holdKey==="l")move(-1);if(holdKey==="r")move(1);if(holdKey==="d")softDrop();}
function stopHold(){clearInterval(holdTimer);holdKey=null;}

leftBtn.onmousedown=()=>startHold("l");
rightBtn.onmousedown=()=>startHold("r");
downBtn.onmousedown=()=>startHold("d");
rotBtn.onclick=rotate;
document.onmouseup=stopHold;

// ==================== 触屏手势 ====================
let startX=0,startY=0;
canvas.addEventListener("touchstart",e=>{const t=e.touches[0];startX=t.clientX;startY=t.clientY;});
canvas.addEventListener("touchmove",e=>{
 e.preventDefault();
 const t=e.touches[0];
 const dx=t.clientX-startX,dy=t.clientY-startY;
 if(Math.abs(dx)>BLOCK){dx>0?move(1):move(-1);startX=t.clientX;}
 if(dy>BLOCK){softDrop();startY=t.clientY;}
});
canvas.addEventListener("touchend",e=>{});

requestAnimationFrame(loop);
</script>
</body>
</html>
