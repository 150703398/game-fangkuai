<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Cartoon Tetris Pro</title>

<style>
:root{
  --bg:#6ec6ff;
  --panel:#ffffff;
  --border:#222;
  --shadow:rgba(0,0,0,.25);
}
*{box-sizing:border-box;touch-action:none;}
body{
  margin:0;
  background:linear-gradient(#6ec6ff,#b2ebf2);
  font-family:"Comic Sans MS","Arial Rounded MT Bold",system-ui;
  display:flex;
  justify-content:center;
}
#app{
  width:100%;
  max-width:520px;
  padding:8px;
}
.panel{
  background:var(--panel);
  border:4px solid var(--border);
  border-radius:16px;
  box-shadow:0 6px 0 var(--shadow);
  padding:8px;
  margin-bottom:8px;
}
#top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  border:3px solid #222;
  border-radius:12px;
  background:#ffeb3b;
  font-size:16px;
  padding:6px 12px;
  cursor:pointer;
  box-shadow:0 4px 0 #c6b800;
}
button:active{transform:translateY(3px);box-shadow:0 1px 0 #c6b800;}
#gameWrap{
  display:flex;
  gap:8px;
}
#canvasWrap{
  flex:1;
  aspect-ratio:10/20;
}
canvas{
  width:100%;
  height:100%;
  background:#111;
  border-radius:12px;
}
#side{
  width:110px;
}
#next{
  width:100%;
  aspect-ratio:1/1;
  background:#222;
  border-radius:12px;
}
#info{
  font-size:14px;
  text-align:center;
}
#help{
  text-align:center;
  font-size:14px;
}
</style>
</head>

<body>
<div id="app">

<div id="top" class="panel">
  <button id="start">▶ 开始</button>
  <div>
    分数：<span id="score">0</span><br>
    难度：
    <select id="difficulty">
      <option value="easy">简单</option>
      <option value="normal" selected>普通</option>
      <option value="hard">困难</option>
    </select>
  </div>
</div>

<div id="gameWrap">
  <div id="canvasWrap" class="panel">
    <canvas id="game" width="300" height="600"></canvas>
  </div>
  <div id="side">
    <div class="panel">
      <div style="text-align:center;font-weight:bold">NEXT</div>
      <canvas id="next" width="100" height="100"></canvas>
    </div>
  </div>
</div>

<div id="help" class="panel">
操作说明：向上：旋转，向左：左移，向右：右移，向下：下移
</div>

</div>

<script>
/* =================== 配置 =================== */
const COLS=10,ROWS=20;
const BLOCK=30;
const CF_API_URL="https://fktop.wuyuping7262.workers.dev/"; // ← 改这里

/* =================== 画布 =================== */
const cvs=document.getElementById("game");
const ctx=cvs.getContext("2d");
const nextCvs=document.getElementById("next");
const nctx=nextCvs.getContext("2d");

/* =================== 方块数据 =================== */
const COLORS={
 I:"#00e5ff",J:"#2979ff",L:"#ff9100",
 O:"#ffd600",S:"#00e676",T:"#d500f9",Z:"#ff1744"
};

/* 标准 SRS */
const SHAPES={
 I:[
  [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  [[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]
 ],
 O:[
  [[1,1],[1,1]]
 ],
 T:[
  [[0,1,0],[1,1,1],[0,0,0]],
  [[0,1,0],[0,1,1],[0,1,0]],
  [[0,0,0],[1,1,1],[0,1,0]],
  [[0,1,0],[1,1,0],[0,1,0]]
 ],
 J:[
  [[1,0,0],[1,1,1],[0,0,0]],
  [[0,1,1],[0,1,0],[0,1,0]],
  [[0,0,0],[1,1,1],[0,0,1]],
  [[0,1,0],[0,1,0],[1,1,0]]
 ],
 L:[
  [[0,0,1],[1,1,1],[0,0,0]],
  [[0,1,0],[0,1,0],[0,1,1]],
  [[0,0,0],[1,1,1],[1,0,0]],
  [[1,1,0],[0,1,0],[0,1,0]]
 ],
 S:[
  [[0,1,1],[1,1,0],[0,0,0]],
  [[0,1,0],[0,1,1],[0,0,1]]
 ],
 Z:[
  [[1,1,0],[0,1,1],[0,0,0]],
  [[0,0,1],[0,1,1],[0,1,0]]
 ]
};

/* =================== 游戏核心 =================== */
let grid,cur,next,score=0,dropTimer=0,dropInterval=800,playing=false;

/* =================== 初始化 =================== */
function reset(){
 grid=[...Array(ROWS)].map(()=>Array(COLS).fill(0));
 cur=randomPiece();
 next=randomPiece();
 score=0;
 updateScore();
}

/* =================== 工具 =================== */
function randomPiece(){
 const keys=Object.keys(SHAPES);
 const k=keys[Math.random()*keys.length|0];
 return {type:k,rot:0,x:3,y:0};
}
function collide(p,dx=0,dy=0,rot=p.rot){
 const s=SHAPES[p.type][rot];
 for(let y=0;y<s.length;y++)
 for(let x=0;x<s[y].length;x++){
  if(!s[y][x])continue;
  let nx=p.x+x+dx, ny=p.y+y+dy;
  if(nx<0||nx>=COLS||ny>=ROWS)return true;
  if(ny>=0 && grid[ny][nx])return true;
 }
 return false;
}

/* =================== 控制 =================== */
document.addEventListener("keydown",e=>{
 if(!playing)return;
 if(e.key==="ArrowLeft"&&!collide(cur,-1,0))cur.x--;
 if(e.key==="ArrowRight"&&!collide(cur,1,0))cur.x++;
 if(e.key==="ArrowDown")softDrop();
 if(e.key==="ArrowUp")rotate();
});

let startY,startX;
cvs.addEventListener("pointerdown",e=>{
 startX=e.clientX; startY=e.clientY;
});
cvs.addEventListener("pointerup",e=>{
 let dx=e.clientX-startX, dy=e.clientY-startY;
 if(Math.abs(dx)>Math.abs(dy)){
  if(dx>30&&!collide(cur,1,0))cur.x++;
  if(dx<-30&&!collide(cur,-1,0))cur.x--;
 }else{
  if(dy>30)softDrop();
  if(dy<-30)rotate();
 }
});

/* =================== 行为 =================== */
function rotate(){
 let r=(cur.rot+1)%SHAPES[cur.type].length;
 if(!collide(cur,0,0,r))cur.rot=r;
}
function softDrop(){
 if(!collide(cur,0,1))cur.y++;
}
function lock(){
 const s=SHAPES[cur.type][cur.rot];
 s.forEach((row,y)=>row.forEach((v,x)=>{
  if(v && cur.y+y>=0)grid[cur.y+y][cur.x+x]=cur.type;
 }));
 clearLines();
 cur=next; next=randomPiece();
 if(collide(cur,0,0))playing=false;
}
function clearLines(){
 for(let y=ROWS-1;y>=0;y--){
  if(grid[y].every(v=>v)){
   grid.splice(y,1);
   grid.unshift(Array(COLS).fill(0));
   score+=100;
   y++;
  }
 }
 updateScore();
}
function updateScore(){
 document.getElementById("score").textContent=score;
}

/* =================== 绘制 =================== */
function drawBlock(x,y,c){
 ctx.fillStyle=c;
 ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);
 ctx.strokeStyle="#000";
 ctx.strokeRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);
}
function draw(){
 ctx.clearRect(0,0,cvs.width,cvs.height);
 grid.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(x,y,COLORS[v])));
 const s=SHAPES[cur.type][cur.rot];
 s.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(cur.x+x,cur.y+y,COLORS[cur.type])));
 drawNext();
}
function drawNext(){
 nctx.clearRect(0,0,100,100);
 const s=SHAPES[next.type][0];
 const offX=(4-s[0].length)/2;
 const offY=(4-s.length)/2;
 s.forEach((r,y)=>r.forEach((v,x)=>{
  if(v){
   nctx.fillStyle=COLORS[next.type];
   nctx.fillRect((x+offX)*20,(y+offY)*20,20,20);
   nctx.strokeRect((x+offX)*20,(y+offY)*20,20,20);
  }
 }));
}

/* =================== 循环 =================== */
function loop(t){
 if(!playing)return;
 dropTimer+=16;
 if(dropTimer>dropInterval){
  dropTimer=0;
  if(!collide(cur,0,1))cur.y++;
  else lock();
 }
 draw();
 requestAnimationFrame(loop);
}

/* =================== 启动 =================== */
document.getElementById("start").onclick=()=>{
 reset();
 playing=true;
 requestAnimationFrame(loop);
};
</script>
</body>
</html>
