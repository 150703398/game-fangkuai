<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ä¿„ç½—æ–¯æ–¹å— Ultimate</title>

<style>
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.app{
  max-width:360px;
  width:100%;
  background:#020617;
  border-radius:16px;
  padding:14px;
  box-shadow:0 20px 50px rgba(0,0,0,.6);
}
canvas{
  width:100%;
  background:#000;
  border-radius:8px;
}
.row{
  display:flex;
  justify-content:space-between;
  margin:8px 0;
  font-size:14px;
}
.controls{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-top:10px;
}
.btn{
  padding:10px;
  font-size:16px;
  font-weight:bold;
  border:none;
  border-radius:10px;
  background:#0ea5e9;
  color:#020617;
}
.btn.alt{background:#22d3ee}
.btn.warn{background:#facc15}
.btn.danger{background:#fb7185}
.btn:active{transform:scale(.95)}
select{
  width:100%;
  padding:8px;
  border-radius:8px;
}
.rank{
  font-size:12px;
  margin-top:8px;
  background:#020617;
  padding:8px;
  border-radius:8px;
}
.rank div{opacity:.85}
</style>
</head>

<body>
<div class="app">

<canvas id="cv" width="300" height="600"></canvas>

<div class="row">
  <div>åˆ†æ•°ï¼š<span id="score">0</span></div>
  <div>ç­‰çº§ï¼š<span id="level">1</span></div>
</div>

<div class="row">
  <select id="difficulty">
    <option value="easy">ç®€å•</option>
    <option value="normal" selected>æ™®é€š</option>
    <option value="hard">å›°éš¾</option>
  </select>
</div>

<div class="row">
  <button class="btn alt" onclick="toggleMusic()">ğŸµ BGM</button>
  <button class="btn alt" onclick="toggleSound()">ğŸ”Š éŸ³æ•ˆ</button>
</div>

<div class="row">
  <button class="btn" onclick="start()">â–¶ å¼€å§‹</button>
  <button class="btn warn" onclick="pause()">â¸ æš‚åœ</button>
  <button class="btn danger" onclick="reset()">â†» é‡æ¥</button>
</div>

<div class="controls">
  <button class="btn" onclick="move(-1)">â†</button>
  <button class="btn" onclick="rotate()">âŸ³</button>
  <button class="btn" onclick="move(1)">â†’</button>
  <button class="btn" onclick="drop()">â†“</button>
  <button class="btn" onclick="hardDrop()">â¤“</button>
  <button class="btn" onclick="start()">â–¶</button>
</div>

<div class="rank" id="rank"></div>

</div>

<script>
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
const COL=10,ROW=20,S=30;
const COLORS=["","#22d3ee","#a78bfa","#34d399","#facc15","#fb7185"];
const SHAPES=[
 [[1,1,1,1]],
 [[2,0,0],[2,2,2]],
 [[0,3,3],[3,3,0]],
 [[4,4],[4,4]],
 [[0,5,0],[5,5,5]]
];

let board,piece,score=0,level=1;
let speed=600,playing=false,timer=null;
let soundOn=true,musicOn=true;

const scoreEl=score=document.getElementById("score");
const levelEl=document.getElementById("level");

const sndDrop=new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YRAAAA==");
const bgm=new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YRAAAA==");
bgm.loop=true;

function reset(){
  board=Array.from({length:ROW},()=>Array(COL).fill(0));
  score=0; level=1;
  updateDifficulty();
  newPiece();
  draw();
}
reset();

function updateDifficulty(){
  const d=document.getElementById("difficulty").value;
  speed=d==="easy"?800:d==="hard"?350:550;
}

function newPiece(){
  const s=SHAPES[Math.random()*SHAPES.length|0];
  piece={s,x:3,y:0};
  if(collide()){ saveRank(); reset(); }
}

function collide(){
  return piece.s.some((r,y)=>r.some((v,x)=>{
    if(!v)return false;
    let nx=piece.x+x, ny=piece.y+y;
    return nx<0||nx>=COL||ny>=ROW||board[ny]?.[nx];
  }));
}

function merge(){
  piece.s.forEach((r,y)=>r.forEach((v,x)=>{
    if(v)board[piece.y+y][piece.x+x]=v;
  }));
  if(soundOn) sndDrop.play();
}

function clearLines(){
  board=board.filter(r=>{
    if(r.every(v=>v)){ score+=100; return false; }
    return true;
  });
  while(board.length<ROW)board.unshift(Array(COL).fill(0));
  level=1+Math.floor(score/500);
}

function draw(){
  ctx.clearRect(0,0,300,600);
  board.forEach((r,y)=>r.forEach((v,x)=>{
    if(v){ctx.fillStyle=COLORS[v];ctx.fillRect(x*S,y*S,S-1,S-1);}
  }));
  piece.s.forEach((r,y)=>r.forEach((v,x)=>{
    if(v){ctx.fillStyle=COLORS[v];ctx.fillRect((piece.x+x)*S,(piece.y+y)*S,S-1,S-1);}
  }));
  document.getElementById("score").textContent=score;
  document.getElementById("level").textContent=level;
}

function tick(){
  if(!playing)return;
  piece.y++;
  if(collide()){
    piece.y--;
    merge();
    clearLines();
    newPiece();
  }
  draw();
  timer=setTimeout(tick,speed);
}

function start(){
  if(playing)return;
  playing=true;
  updateDifficulty();
  if(musicOn) bgm.play();
  tick();
}

function pause(){
  playing=false;
  clearTimeout(timer);
  bgm.pause();
}

function move(d){
  piece.x+=d;
  if(collide())piece.x-=d;
  draw();
}

function rotate(){
  const p=piece.s;
  piece.s=piece.s[0].map((_,i)=>piece.s.map(r=>r[i]).reverse());
  if(collide())piece.s=p;
  draw();
}

function drop(){
  piece.y++;
  if(collide())piece.y--;
  draw();
}

function hardDrop(){
  while(!collide())piece.y++;
  piece.y--;
  merge();
  clearLines();
  newPiece();
  draw();
}

document.onkeydown=e=>{
  if(e.key==="ArrowLeft")move(-1);
  if(e.key==="ArrowRight")move(1);
  if(e.key==="ArrowUp")rotate();
  if(e.key==="ArrowDown")drop();
  if(e.key===" ")hardDrop();
};

function toggleSound(){ soundOn=!soundOn; }
function toggleMusic(){ musicOn=!musicOn; musicOn?bgm.play():bgm.pause(); }

/* æœ¬åœ°æ’è¡Œæ¦œ */
function saveRank(){
  const r=JSON.parse(localStorage.getItem("tetrisRank")||"[]");
  r.push({score,date:new Date().toLocaleString()});
  r.sort((a,b)=>b.score-a.score);
  localStorage.setItem("tetrisRank",JSON.stringify(r.slice(0,5)));
  renderRank();
}
function renderRank(){
  const r=JSON.parse(localStorage.getItem("tetrisRank")||"[]");
  document.getElementById("rank").innerHTML=
    "<b>ğŸ† æœ¬åœ°æ’è¡Œæ¦œ</b>"+r.map((v,i)=>`<div>${i+1}. ${v.score}</div>`).join("");
}
renderRank();
</script>
</body>
</html>
